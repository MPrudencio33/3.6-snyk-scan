name: CI Checks
run-name: Running Terraform Checks by ${{ github.actor }}

permissions:
  contents: read
  pull-requests: write
  statuses: write

on:
  pull_request:
    branches: [ "*" ]

jobs:
  Initial-Checks:
    runs-on: ubuntu-latest
    steps:
      - name: Getting initiator name
        run: echo "Workflow initiated by ${{ github.actor }} from branch ${{ github.ref_name }}"

  terraform-checks:
    runs-on: ubuntu-latest
    needs: Initial-Checks
    outputs:
      status: ${{ job.status }}
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: terraform fmt -check
      - run: terraform init -backend=false
      - run: terraform validate -no-color
      - uses: terraform-linters/setup-tflint@v3
      - run: tflint --init
      - run: tflint -f compact

  snyk-scans:
    runs-on: ubuntu-latest
    needs: terraform-checks
    outputs:
      status: ${{ job.status }}
    steps:
      - uses: actions/checkout@v3
      - run: npm install -g snyk
      - uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
      - run: snyk iac test --severity-threshold=high
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  summary:
    needs: [terraform-checks, snyk-scans]
    runs-on: ubuntu-latest
    steps:
      - name: Add summary
        run: |
          echo "## ðŸš€ Build Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform | ${{ needs.terraform-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Snyk | ${{ needs.snyk-scans.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Workflow triggered by ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY